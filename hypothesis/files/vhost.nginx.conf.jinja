{#
 #
 # Expected variables value:
 #   - hypothesis_host: '127.0.0.1'
 #   - hypothesis_port: 8000
 #}
server {
    listen        80;
    server_name   notes.webplatform.org;
    server_tokens off;
    return        301 https://notes.webplatform.org$request_uri;
}

server {
    listen        80;
    server_name   notes.webplatformstaging.org;
    server_tokens off;
    return        301 https://notes.webplatformstaging.org$request_uri;
}

server {
    listen              443 ssl spdy;
    ssl                 on;
    ssl_certificate     /etc/ssl/webplatform/ssl.pem;
    ssl_certificate_key /etc/ssl/webplatform/201407.key;

    root                /srv/webplatform/notes-server/notes_server/static/;
    server_name         notes.webplatform.org notes.webplatformstaging.org;

    server_tokens off;
    access_log    /var/log/nginx/notes.access.log;
    error_log     /var/log/nginx/notes.error.log;

    # All static files will be served directly?
    # See: http://stackoverflow.com/questions/19515132/nginx-cache-static-files#answer-20843725 and Joost van der Laan

    rewrite ^/$              https://$host/stream   permanent;

    error_page 500 /errors/500.html;
    error_page 502 /errors/502.html;
    error_page 503 /errors/503.html;
    error_page 504 /errors/500.html;
    error_page 505 /errors/500.html;
    error_page 403 /errors/403.html;
    error_page 404 /errors/404.html;
    location ^~ /errors/ {
        internal;
        root /srv/webplatform;
    }

    # See also:
    #  - https://www.varnish-cache.org/docs/3.0/tutorial/websockets.html
    #  - http://thruflo.com/post/23226473852/websockets-varnish-nginx
    # ... but we should upgrade to NGINX 1.3+
    #
    location / {
        proxy_pass       http://{{ hypothesis_host }}:{{ hypothesis_port }};
        proxy_set_header Host               $http_host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        proxy_intercept_errors on;

        # WebSocket support (nginx 1.4+)
        proxy_http_version 1.1;
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         "upgrade";
    }
}

