{#
 # Expected variables value:
 #   - hypothesis_host: '127.0.0.1'
 #   - hypothesis_port: 8001
 #}
server {
    listen        80;
    server_name   {{ subDomainName }}.{{ tld }};
    server_tokens off;
    return        301 https://{{ subDomainName }}.{{ tld }}$request_uri;
}

server {
    listen              443 ssl spdy;
    ssl                 on;
    ssl_certificate     /etc/ssl/webplatform/public_default_201407.pem;
    ssl_certificate_key /etc/ssl/webplatform/201407.key;

    root         /srv/webplatform/notes-server/notes_server/static;
    server_name  {{ subDomainName }}.{{ tld }};

    include      common_params;
    include      ssl_params;

    rewrite      ^/app/embed.js$ /annotator.js permanent;

    location   = /annotator.js {
      rewrite    ^/annotator.js$  /embed.js last;
    }

    rewrite      ^/assets/notes-server/(.*)\? /$1;

    location / {
        proxy_pass       http://{{ hypothesis_host }}:{{ hypothesis_port }};
        proxy_set_header Host               $http_host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        proxy_intercept_errors on;

        # WebSocket support (nginx 1.4+)
        proxy_http_version 1.1;
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         "upgrade";
    }
}

