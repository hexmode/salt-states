
#
# This is the internal network HTTP proxy for notes.{{ tld }}
# served through non SSL as notes.backend.{{ level }}.wpdn
#
# The purpose of this virtual host is to take care of every web application
# specific FastCGI proxying, URL rewrites AND static files handling.
#
# Note that we override here the Host header to notes.{{ tld }} and override
# the X-Forwarded-Protocol in purpose so that the public vhost and this one
# works together to deliver publicly over SSL correctly.
#
# Intention is that we can have multiple IPs internally to serve this web app.
#
# ===========================================================================
#
# Managed by Salt Stack. Do NOT Edit manually!
# source: {{ source }}

server {
    listen        80;
    server_name   notes.backend.{{ level }}.wpdn;

    include      common_params;

    root         /srv/webplatform/notes-server/notes_server/static;

    rewrite      ^/app/embed.js$ /annotator.js permanent;

    location   = /annotator.js {
      rewrite    ^/annotator.js$  /embed.js last;
    }

    rewrite      ^/assets/notes-server/(.*)\? /$1;

    location / {
        proxy_pass       http://127.0.0.1:{{ hypothesis_port }};

        # Since this vhost is neither as SSL, nor with hostname notes.webplatform.org,
        # we MUST rename it and ommit that we passed through non ssl internally.
        proxy_set_header Host notes.{{ tld }};

        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;

        proxy_intercept_errors on;

        # WebSocket support (nginx 1.4+)
        proxy_http_version 1.1;
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         "upgrade";
    }
}

