
#
# This is the internal network HTTP proxy for stats.{{ tld }}
# served through non SSL as stats.backend.{{ level }}.wpdn
#
# The purpose of this virtual host is to take care of every web application
# specific FastCGI proxying, URL rewrites AND static files handling.
#
# Note that we override here the Host header to stats.{{ tld }} and override
# the X-Forwarded-Protocol in purpose so that the public vhost and this one
# works together to deliver publicly over SSL correctly.
#
# Intention is that we can have multiple IPs internally to serve this web app.
#
# ===========================================================================
#
# Managed by Salt Stack. Do NOT Edit manually!
# source: {{ source }}

server {
    listen        80;

    root         /srv/webplatform/stats-server;
    server_name  stats.backend.{{ level }}.wpdn;

    include      common_params;

    location / {
        try_files $uri /index.php;
    }

    # Relay all index.php requests to fastcgi.
    location ~* ^/(?:index|piwik)\.php$ {
        fastcgi_pass {{ grains['ipaddr'] }}:{{ piwik_port }};

        # Since this vhost is neither as SSL, nor with hostname stats.{{ tld }},
        # we MUST rename it and ommit that we passed through non ssl internally.
        # ... this one is specific to PHP php5-fpm
        fastcgi_param HTTP_HOST stats.{{ tld }};

        include      fastcgi_params;
        include      proxy_params;
    }

    # Any other attempt to access PHP files returns a 404.
    location ~* ^.+\.php$ {
        return 404;
    }

    ## No crawling of this site for bots that obey robots.txt.
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /\n";
    }
}

