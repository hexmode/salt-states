<VirtualHost _default_:80>
  ServerAdmin 	hostmaster@webplatform.org
  ServerName  	www.webplatform.org
  ServerAlias 	www.webplatformstaging.org

  DocumentRoot 	/var/www

  # Removing any cookies from here, we do not want them here
  RequestHeader unset Cookie
  Header unset Set-Cookie

  # http://www.mnot.net/blog/2007/05/15/expires_max-age
  ExpiresActive On
  ExpiresDefault "access plus 1 day"
  #Header set Cache-Control "max-age=3600, must-revalidate"  # Should be done already by ExpiresActive

  <IfModule mod_headers.c>
    Header set X-UA-Compatible "IE=edge,chrome=1"
    # mod_headers can't match by content-type, but we don't want to send this header on *everything*...
    <FilesMatch "\.(appcache|crx|css|eot|gif|htc|ico|jpe?g|js|m4a|m4v|manifest|mp4|oex|oga|ogg|ogv|otf|pdf|png|safariextz|svg|svgz|ttf|vcf|webm|webp|woff|xml|xpi)$">
      Header unset X-UA-Compatible
    </FilesMatch>
  </IfModule>

  <IfModule mod_setenvif.c>
    <IfModule mod_headers.c>
      # mod_headers, y u no match by Content-Type?!
      <FilesMatch "\.(gif|ico|jpe?g|png|svg|svgz|webp)$">
        SetEnvIf Origin ":" IS_CORS
        Header set Access-Control-Allow-Origin "*" env=IS_CORS
      </FilesMatch>
    </IfModule>
  </IfModule>

  <IfModule mod_headers.c>
    <FilesMatch "\.(eot|font.css|otf|ttc|ttf|woff)$">
      Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
  </IfModule>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>
  <Directory /var/www/>
    Options FollowSymLinks
    AllowOverride None
    Order allow,deny
    allow from all
    Require all granted
  </Directory>

  ErrorLog syslog:local1

  # Possible values include: debug, info, notice, warn, error, crit,
  # alert, emerg.
  LogLevel warn

  CustomLog /var/log/apache2/www_access.log combined

  <Directory /srv/webplatform/wiki/images>
    Options -Indexes
    Require all granted
  </Directory>
  <Directory /srv/webplatform/bots/lumberjack>
    Require all granted
  </Directory>

  Alias /talk/chatlogs   /srv/webplatform/lumberjack-web
  Alias /chatlogs        /srv/webplatform/lumberjack-web

  RewriteEngine on

  RedirectMatch ^/.well-known(.+) https://webplatform.org/.well-known$1

  RewriteRule   ^/docs/(.+)  http://docs.webplatform.org/wiki/$1  [R,L]
  RedirectMatch ^/docs/?$    http://docs.webplatform.org/wiki/
  RedirectMatch ^/wiki/?$    http://docs.webplatform.org/wiki/

  # per http://lists.w3.org/Archives/Public/public-webplatform/2013Mar/0174.html
  RewriteCond %{REQUEST_URI}        ^/(beginners|css|dom|concepts|accessibility|svg|html|javascript|apis)
  RewriteRule ^(.*)$                http://docs.webplatform.org/wiki$1   [R=301,L]

  # Error pages
  ErrorDocument 404 /errors/404.html
  ErrorDocument 503 /errors/503.html
  ErrorDocument 500 /errors/500.html
  ErrorDocument 403 /errors/403.html
</VirtualHost>

<VirtualHost *:80>
  ServerAdmin 	hostmaster@webplatform.org
  ServerName  	webplatform.org
  ServerAlias 	webplatformstaging.org

  RewriteEngine on

  RewriteRule   ^/.well-known(.+) https://%{HTTP_HOST}/.well-known$1  [R,L]

  RewriteCond   %{HTTP_HOST}   !^www\. [NC]
  RewriteCond   %{HTTP_HOST}   !^$
  RewriteRule   ^/?(.*)        http://www.%{HTTP_HOST}/$1 [L,R,NE]
</VirtualHost>
