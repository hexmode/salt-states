#cloud-config

## Managed by Salt Stack, do NOT edit manually!
{#
 # Cloud init config
 #
 # This file MUST be pre-generated by Salt to fill the "level" variable as a string identifier (e.g. production)
 #
 # Ref:
 #   - http://cloudinit.readthedocs.org/en/latest/topics/examples.html#call-a-url-when-finished
 #   - https://help.ubuntu.com/community/CloudInit
 #   - http://stackoverflow.com/questions/23411408/how-do-i-set-up-cloud-init-on-custom-amis-in-aws-centos
 #
 # Context variables:
 #   - salt_master_ip
 #   - level
 #
 # Get previous userdata
 #
 #     curl http://169.254.169.254/openstack/2013-10-17/user_data
 #}

manage_etc_hosts: false # Has to be set to false for everybody. Otherwise we need a DNS
manage-resolv-conf: false


locale: en_US.UTF-8
timezone: America/New_York
package_upgrade: true
package_update: true
package_reboot_if_required: true


#
# This is run at EVERY boot, good to ensure things are at the right place
#
bootcmd:
  - grep -q -e 'nameserver' /etc/resolvconf/resolv.conf.d/head || printf "nameserver {{ salt_master_ip }}\n" >> /etc/resolvconf/resolv.conf.d/head
  - grep -q -e 'wpdn' /etc/resolvconf/resolv.conf.d/base || printf "search {{ level }}.wpdn\ndomain {{ level }}.wpdn\nnameserver 8.8.8.8" > /etc/resolvconf/resolv.conf.d/base
  - grep -q -e 'wpdn' /etc/resolv.conf || resolvconf -u


runcmd:
  - sed -i "s/127.0.0.1 localhost/127.0.1.1 $(hostname).{{ level }}.wpdn $(hostname)\n127.0.0.1 localhost/" /etc/hosts
  - add-apt-repository -y ppa:saltstack/salt
  - apt-get update
  - apt-get -y upgrade
  - apt-get -y autoremove
  - apt-get -y upgrade salt-minion
  - apt-get -y dist-upgrade

write_files:
  - encoding: b64
    content: {{ base64_yaml_level_line }}
    path: /etc/salt/grains

# The content property above ^ contains a base64 encoded string that contains "level: foo" (without quotes)
# it was meant to make sure that cloudinit wouldnâ€™t break because it was taking previous attempts as part
# of the rest of this YAML document.



packages:
  - salt-minion
  - salt-common
  - python-software-properties
  - software-properties-common

final_message: "All my work here is done"


# vim: et ts=2 sw=2 ft=yaml:

