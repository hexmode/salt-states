{# TODO: REFACTOR THIS FILE! #}

server {
    # Don't forget to tell on which port this server listens
    listen 80;

    {% if 'aliases' in args -%}
    # Listen on the www host
    server_name {{ args.aliases|join(" ") }};
    {%- endif -%}

    # Redirect to the non-www host (declared below)
    return 301 $scheme://{{ args.name }}$request_uri;
}

server {
    {% if 'default' in args and args.default == True -%}
    listen 80 default_server;
    {%- endif %}

    # The host name to respond to
    server_name {{ args.name }};

    # Index file
    index index.php index.html index.htm;

    root /srv/webplatform/{{ site }};

    # Logging
    access_log /var/log/nginx/{{ site }}.access.log;
    error_log /var/log/nginx/{{ site }}.error.log notice;

    # Specify a charset
    charset utf-8;

    # Custom 404 page
    error_page 404 /static/404.html;

    {% if 'php' in args -%}{# TODO FIX THIS!! as EVERY site is php without that #}
    location ~ \.php$ {
        set $no_cache 0;

        proxy_set_header  X-Real-IP          $remote_addr;
        proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto  $scheme;
        proxy_set_header  Host  $http_host;
        proxy_set_header  X-NginX-Proxy  true;
        fastcgi_param REMOTE_ADDR $http_x_real_ip;

        if ($request_method !~ ^(GET|HEAD)$) {
            set $no_cache 1;
        }

        if ($no_cache = 1) {
            add_header Set-Cookie "_mcnc=1; Max-Age=2; Path=/";
            add_header X-Microcachable "0";
        }

        if ($http_cookie ~* "_mcnc") {
            set $no_cache 1;
        }

        fastcgi_no_cache $no_cache;
        fastcgi_cache_bypass $no_cache;
        fastcgi_cache microcache;
        fastcgi_cache_key $host$request_uri;
        fastcgi_cache_valid 200 301 302 10m;
        fastcgi_cache_use_stale updating error timeout invalid_header http_500;
        fastcgi_pass_header Set-Cookie;
        fastcgi_pass_header Cookie;
        fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

        try_files $uri = 404;
        fastcgi_pass unix://tmp/{{ site }}.socket;
        fastcgi_index index.php;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        fastcgi_read_timeout 240;

        include /etc/nginx/fastcgi_params;
    }

    {% endif %}

    include /etc/nginx/custom.d/optimize.conf;
}
