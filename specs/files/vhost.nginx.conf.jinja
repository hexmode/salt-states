
#
# This is the PUBLIC virtual host for specs.{{ tld }},
# proxying requests to an internal webserver.
#
# ===========================================================================
#
# Managed by Salt Stack. Do NOT edit manually!
# source: {{ source }}

upstream backend_publican {
{%- for b in backends_publican %}
    server    {{ b }}:{{ backend_port_publican }};
{%- endfor %}
}

upstream backend_specs {
{%- for b in backends %}
    server    {{ b }}:{{ backend_port }};
{%- endfor %}
    ddkeepalive 16;
}

server {
    listen      80;
    server_name specs.{{ tld }};
    include     common_params;
    return      301 https://specs.{{ tld }}$request_uri;
}

server {
    listen      443 ssl spdy;
    server_name specs.{{ tld }};

    root        /var/www;
    include     common_params;
    include     ssl_params;

    ssl                 on;
    ssl_certificate     /etc/ssl/webplatform/public_default_201407.pem;
    ssl_certificate_key /etc/ssl/webplatform/201407.key;

    location    /hook {
        proxy_pass       http://backend_publican;
        proxy_set_header Host $http_host;
    }

    location    / {
        try_files @specs =404;
    }

    location @specs {
        proxy_pass       http://backend_specs;
        proxy_set_header Host $http_host;

        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_intercept_errors on;

        # Backend keepalive
        # ref: http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

